<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">

    <script src="js/jquery.min.js"></script>
    <script src="js/common.js"></script>
    <script src="js/memory.js"></script>
    <script src="js/mmixcommands.js"></script>
    <script src="js/processor.js"></script>


    <script src="js/bootstrap.min.js"></script>

    <script src="tasks/part1.js"></script>
    <style type="text/css">
        #results .resItem {
            border: 1px solid beige;
        }
        #results .wrong {
            background-color: greenyellow;

        }
        #results .ok {
            background-color: magenta;
        }
    </style>

    <script>
        shared = window

        shared.regs = new shared.Registers(256)
        shared.mem = new shared.Memory(1024)
        shared.proc = new shared.MMIXProcessor(mem, regs)

        $(document).ready(function() {
            for(var i = 0; i < shared.tasks.length; i++) {
                for(var j = 0; j < shared.tasks[i].length; j++) {
                    var opt = $("<option>" + (i + 1) + " - " + (j + 1) + "</option>");
                    $("#task").append(opt);
                    opt.attr("value", [i,j])
                }
            }
        });

        var cmd = {}

        cmd.load = function(obj) {
            // loading program
            var src = $('#program')[0].value.replace(/[^0-9A-Fa-f]/gi, "")
            var len = src.length;
            if (len % 8 != 0) {
                alert("wrong line");
            }

            for (var i = 0; i < len / 8; i++) {
                shared.mem.setTetra(i * 4, parseInt(src.substr(i * 8, 8), 16) )
            }
            return true;
        }
        cmd.get = function(obj) {
            switch(obj.size) {
                case 8:
                    if (obj.val instanceof shared.OctaByte) {
                        return shared.mem.getOcta(obj.addr).cmpu(obj.val) == 0;
                    } else {
                        return shared.mem.getOcta(obj.addr).cmpu(new shared.OctaByte(0, obj.val)) == 0;
                    }
                    break;
            }
            return true;
        }
        cmd.go = function(obj) {
            shared.proc.run();
            return true;
        }
        cmd.set = function(obj) {
            switch(obj.size) {
                case 8:
                    if (obj.val instanceof shared.OctaByte) {
                        shared.mem.setOcta(obj.addr, obj.val);
                    } else {
                        shared.mem.setOcta(obj.addr, new shared.OctaByte(0, obj.val));
                    }
                    break;
            }
            return true;
        }
        cmd.reg = function(obj) {
            switch(obj.val) {
                case "random":
                    for(var i = 0 ; i < shared.regs.size(); i++) {
                        shared.regs.setOcta(i, new shared.OctaByte(
                                Math.floor(Math.random() * Math.pow(2, 32)),
                                Math.floor(Math.random() * Math.pow(2, 32))
                        ));
                    }
                    break;
            }
            return true;
        }
        cmd.mem = function(obj) {
            switch(obj.val) {
                case "random":
                    for(var i = 0 ; i < shared.mem.size(); i++) {
                        shared.mem.setByte(i, Math.floor(Math.random() * 255));
                    }
                    break;
            }
            return true;
        }

        function goTask(opt) {
            var a = eval("([" + opt + "])");
            var task = shared.tasks[a[0]][a[1]];

            var res = $("#results");
            res.empty();
            for(var i = 0; i < task.length; i++) {
                try {
                    var tli = $("<li>"+JSON.stringify(task[i])+"</li>")
                    res.append(tli);
                    tli.addClass("resItem")
                    if (cmd[task[i].cmd](task[i])) {
                        tli.addClass("wrong");
                    } else {
                        tli.addClass("ok");
                    }
                } catch(e) {
                    alert("error! with cmd = " + task[i].cmd)
                }
            }

        }
    </script>
</head>
<body>
<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-6">
            <textarea id="program"></textarea>
        </div>
        <div class="col-6">
            <select id="task"></select><button onclick="goTask($('#task').val())">Run Test</button>

            <ol id="results"></ol>
        </div>
    </div>


</div><!-- /.container -->

</body>
</html>
